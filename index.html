<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The remaining time</title>
</head>
<body>
    

    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment-precise-range-plugin@1.3.0/moment-precise-range.min.js"></script>

    <script>
        bg = {
            black: [ "transparent", "yellow", "cyan" ]
        }
        const g = (date, st) => !date ? "" : `${date}${st} `

        TrelloPowerUp.initialize({
            // show remaining time
            "card-badges": (t, opts) => {
                // let cardAttachments = opts.attachments; // Trello passes you the attachments on the card
                return t
                .card("all")
                // .get("name", "id")
                .then(card => {
                    var due = card.due
                    var start = card.badges.start
                    var dueComplete = card.dueComplete
                    var color = null
                    return [
                    {
                        // Dynamic badges can have their function rerun
                        // after a set number of seconds defined by refresh.
                        // Minimum of 10 seconds.
                        // we could also return a Promise that resolves to
                        // this as well if we needed to do something async first
                        dynamic: async() => {
                            const { board: { shared: { bgStart, bgEnd } } } = await t.getAll("board", "shared")
                            console.log(bgStart, bgEnd)
                            var time;
                            return {
                                text: (() => {
                                    console.log(1)
                                    time = false
                                    if (dueComplete) return null
                                    if (start) {
                                        start = new Date(start)
                                        now = new Date()
                                        m = new Date(start - now)
                                        console.log(2)
                                        if (m > 0) {
                                            time = true
                                            start = moment(start)
                                            now = moment(now)
                                            d = moment.preciseDiff(start, now, true)
                                            color = bgStart == "transparent" ? null : bgStart
                                            console.log(3)
                                            return g(d["year"], "Y") + g(d["months"], "M") + g(d["days"], "D") + g(d["hours"], "H") + g(d["minutes"], "M") + " to Start"
                                        }
                                    }
                                    
                                    console.log(4)
                                    if (!due) return null
                                    due = new Date(due)
                                    now = new Date()
                                    m = new Date(due - now)
                                    console.log(5)
                                    if (m < 0) return null
                                    time = true
                                    due = moment(due)
                                    now = moment(now)
                                    d = moment.preciseDiff(due, now, true)
                                    color = bgEnd == "transparent" ? null : bgEnd
                                    console.log(6)
                                    // if (d["hours"] < 5 && d["days"] == 0 && d["months"] == 0 && d["year"] == 0) color = "yellow"
                                    return g(d["year"], "Y") + g(d["months"], "M") + g(d["days"], "D") + g(d["hours"], "H") + g(d["minutes"], "M") + "to Finish"
                                    // return `${}:`
                                })(),
                                color: color,
                                icon: time ? "./time.png" : null,
                                refresh: 60
                            }
                        }
                    },
                    ];
                });
            },
            // show settings
            "show-settings": t => t.popup({
                title: "settings",
                url: "./settings.html",
                height: 150
            }),
            "on-enable": t => {
                t.set("board", "shared", "bgStart", "transparent")
                t.set("board", "shared", "bgEnd", "green")
            }
        })
    </script>

</body>
</html>